auth.py
from passlib.context import CryptContext
from datetime import datetime, timedelta
from jose import JWTError, jwt
from typing import Optional

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ
SECRET_KEY = "a_very_secret_key_for_jwt" # Ø§ÛŒÙ† Ú©Ù„ÛŒØ¯ Ø±Ø§ Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 30

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def verify_password(plain_password, hashed_password):
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password):
    return pwd_context.hash(password)

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt

auth_api.py
from fastapi import Depends, Header, HTTPException, status
from sqlalchemy.orm import Session
from .database import get_db
from .models import APIKey


def get_current_service_user(
    db: Session = Depends(get_db),
    authorization: str = Header(None, alias="Authorization"),
):
    """
    Ø¯Ø±ÛŒØ§ÙØª Bearer <token> Ùˆ ØªØ­ÙˆÛŒÙ„ ÛŒÙˆØ²Ø± Ø³Ø±ÙˆÛŒØ³
    """
    if not authorization or not authorization.lower().startswith("bearer "):
        raise HTTPException(status.HTTP_401_UNAUTHORIZED, "Missing token")
    token = authorization.split(" ", 1)[1].strip()

    api_key = (
        db.query(APIKey)
        .filter(APIKey.key == token, APIKey.is_active.is_(True))
        .first()
    )
    if not api_key:
        raise HTTPException(status.HTTP_403_FORBIDDEN, "Invalid token")

    return api_key.owner  # -> models.User



# app/celery_app.py
from celery import Celery
import os
from dotenv import load_dotenv

load_dotenv()

# Ù…Ø«Ø§Ù„: redis Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 6379 Ù„ÙˆÚ©Ø§Ù„
broker_url  = os.getenv("CELERY_BROKER_URL",  "redis://localhost:6379/0")
result_url  = os.getenv("CELERY_RESULT_BACKEND", "redis://localhost:6379/1")

celery_app = Celery(
    "dastyaresot",
    broker=broker_url,
    backend=result_url,
    include=["app.tasks"],   # Ù…Ø§Ú˜ÙˆÙ„ Ø­Ø§ÙˆÛŒ ÙˆØ¸Ø§ÛŒÙ
)

# Ú¯Ø²ÛŒÙ†Ù‡Ù” Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ùˆâ€¦ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ù‚Ø§Ø¨Ù„ Ú¯Ø³ØªØ±Ø´ Ø§Ø³Øª)
celery_app.conf.update(
    task_track_started=True,
    task_serializer="json",
    result_serializer="json",
    accept_content=["json"],
    timezone="Asia/Tehran",
)



# app/crud.py
# -*- coding: utf-8 -*-
"""
CRUD helpers for DastYarâ€‘eâ€¯SOT
Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: Û±Û´Û°Û´/Û°Ûµ/Û°Û´
"""

from __future__ import annotations

import os
import uuid
from datetime import date, datetime, timezone, timedelta
from typing import List, Optional

import docx
from sqlalchemy.exc import NoResultFound
from sqlalchemy.orm import Session

from . import models, auth


# =============================================================================
# ğŸ•’ Helper
# =============================================================================
def _now_tehran() -> datetime:
    return datetime.now(timezone(timedelta(hours=3, minutes=30)))


# =============================================================================
# ğŸŸ¢  Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
# =============================================================================
def get_user(db: Session, user_id: int) -> models.User | None:
    return db.query(models.User).filter(models.User.id == user_id).first()


def get_user_by_username(db: Session, username: str) -> models.User | None:
    return db.query(models.User).filter(models.User.username == username).first()


def get_users(
    db: Session,
    username_filter: str | None = None,
    skip: int = 0,
    limit: int = 100,
):
    q = db.query(models.User)
    if username_filter:
        q = q.filter(models.User.username.contains(username_filter))
    return q.order_by(models.User.id.desc()).offset(skip).limit(limit).all()


def create_user(db: Session, user_create) -> models.User:
    hashed_pw = auth.get_password_hash(user_create.password)
    db_user = models.User(
        username=user_create.username,
        hashed_password=hashed_pw,
        role=user_create.role,
        file_limit=user_create.file_limit,
        wallet_balance=user_create.wallet_balance,
        token_price=user_create.token_price,
    )
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user


def update_user_password(db: Session, user: models.User, new_plain_pw: str):
    user.hashed_password = auth.get_password_hash(new_plain_pw)
    db.commit()


def update_user_details(
    db: Session,
    user_to_update: models.User,
    username: str,
    file_limit: int,
    token_price: float,
):
    user_to_update.username = username
    user_to_update.file_limit = file_limit
    user_to_update.token_price = token_price
    db.commit()
    db.refresh(user_to_update)


# =============================================================================
# ğŸŸ¢  ØªØ±Ø§Ú©Ù†Ø´ Ùˆ Ú©ÛŒÙ Ù¾ÙˆÙ„
# =============================================================================
def create_transaction(
    db: Session,
    user_id: int,
    amount: float,
    description: str,
    token_price: Optional[float] = None,
):
    tx = models.Transaction(
        user_id=user_id,
        amount=amount,
        description=description,
        token_price_at_transaction=token_price,
        timestamp=_now_tehran(),
    )
    db.add(tx)
    return tx


def adjust_user_balance(db: Session, user: models.User, amount: float, description: str):
    if amount == 0:
        return
    user.wallet_balance += amount
    create_transaction(db, user.id, amount, description, user.token_price)
    db.commit()
    db.refresh(user)


def debit_from_wallet(db: Session, user: models.User, cost: float, description: str):
    db.refresh(user)
    if user.wallet_balance < cost:
        raise ValueError("Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø§Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª")
    user.wallet_balance -= cost
    create_transaction(db, user.id, -cost, description, user.token_price)
    db.commit()
    db.refresh(user)


# =============================================================================
# ğŸŸ¢  ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø±ÙˆÙ†ÙˆØ´Øª
# =============================================================================
def create_transcription_record(
    db: Session,
    filename: str,
    user_id: int,
    lang: str,
    original_filename: Optional[str] = None,
) -> models.TranscriptionFile:
    rec = models.TranscriptionFile(
        user_id=user_id,
        original_filename=original_filename or filename,
        display_filename=filename,
        language=lang,
        status="queued",
        timestamp=_now_tehran(),
    )
    db.add(rec)
    db.commit()
    db.refresh(rec)
    return rec


def set_task_id(db: Session, record_id: int, task_id: str):
    rec = db.query(models.TranscriptionFile).get(record_id)
    if rec:
        rec.celery_task_id = task_id
        db.commit()


def update_transcription_status(db: Session, record_id: int, status: str):
    rec = db.query(models.TranscriptionFile).get(record_id)
    if rec:
        rec.status = status
        if status in ("completed", "failed", "canceled"):
            rec.finished_at = _now_tehran()
        db.commit()


def finalize_job(
    db: Session,
    record: models.TranscriptionFile,
    final_text: str,
    duration: int,
):
    record.status = "completed"
    record.final_result_text = final_text
    record.processing_duration_seconds = duration

    base = f"{record.id}_{record.original_filename.rsplit('.', 1)[0]}"
    txt_name = f"{base}.txt"
    with open(os.path.join("uploads", txt_name), "w", encoding="utf-8") as f:
        f.write(final_text)
    record.output_filename_txt = txt_name

    doc = docx.Document()
    doc.add_paragraph(final_text)
    docx_name = f"{base}.docx"
    doc.save(os.path.join("uploads", docx_name))
    record.output_filename_docx = docx_name

    db.commit()


# ---- helpers for cancel ----
def get_job(db: Session, job_id: int, owner: models.User):
    q = db.query(models.TranscriptionFile).filter_by(id=job_id)
    if owner.role != models.Role.admin:
        q = q.filter_by(user_id=owner.id)
    return q.first()


# =============================================================================
# ğŸŸ¢  Ú©ÙˆØ¦Ø±ÛŒâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆÙ†ÙˆØ´Øª Ø¨Ø±Ø§ÛŒ ØµÙØ­Ø§Øª
# =============================================================================
def get_transcription(db: Session, record_id: int) -> models.TranscriptionFile | None:
    """Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯ ÛŒÚ© TranscriptionFile Ø¨Ø± Ø§Ø³Ø§Ø³ ID ÛŒØ§ None."""
    return db.query(models.TranscriptionFile).get(record_id)


def get_user_transcriptions(db: Session, user_id: int, skip: int = 0, limit: int = 15):
    return (
        db.query(models.TranscriptionFile)
        .filter(models.TranscriptionFile.user_id == user_id)
        .order_by(models.TranscriptionFile.timestamp.desc())
        .offset(skip)
        .limit(limit)
        .all()
    )


def get_user_transcriptions_count(db: Session, user_id: int) -> int:
    return db.query(models.TranscriptionFile).filter(models.TranscriptionFile.user_id == user_id).count()


def get_all_transcriptions(db: Session, skip: int = 0, limit: int = 15):
    return (
        db.query(models.TranscriptionFile)
        .order_by(models.TranscriptionFile.timestamp.desc())
        .offset(skip)
        .limit(limit)
        .all()
    )


def get_all_transcriptions_count(db: Session) -> int:
    return db.query(models.TranscriptionFile).count()


def get_transcriptions_by_ids(db: Session, user_id: int, job_ids: List[int]):
    return (
        db.query(models.TranscriptionFile)
        .filter(
            models.TranscriptionFile.id.in_(job_ids),
            models.TranscriptionFile.user_id == user_id,
        )
        .all()
    )


# =============================================================================
# ğŸŸ¢  ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Ú¯Ø²Ø§Ø±Ø´)
# =============================================================================
def get_user_transactions(db: Session, user_id: int, skip: int = 0, limit: int = 15):
    return (
        db.query(models.Transaction)
        .filter(models.Transaction.user_id == user_id)
        .order_by(models.Transaction.timestamp.desc())
        .offset(skip)
        .limit(limit)
        .all()
    )


def get_user_transactions_count(db: Session, user_id: int) -> int:
    return db.query(models.Transaction).filter(models.Transaction.user_id == user_id).count()


def get_all_transactions(
    db: Session,
    username_filter: str | None = None,
    skip: int = 0,
    limit: int = 15,
):
    q = db.query(models.Transaction).join(models.User)
    if username_filter:
        q = q.filter(models.User.username.contains(username_filter))
    return (
        q.order_by(models.Transaction.timestamp.desc())
        .offset(skip)
        .limit(limit)
        .all()
    )


def get_all_transactions_count(db: Session, username_filter: str | None = None) -> int:
    q = db.query(models.Transaction).join(models.User)
    if username_filter:
        q = q.filter(models.User.username.contains(username_filter))
    return q.count()


# =============================================================================
# ğŸŸ¢  Settings
# =============================================================================
def get_setting(db: Session, key: str):
    return db.query(models.Setting).filter(models.Setting.key == key).first()


def update_setting(db: Session, key: str, value: str):
    s = get_setting(db, key)
    if s:
        s.value = value
    else:
        s = models.Setting(key=key, value=value)
        db.add(s)
    db.commit()


def upsert_setting(db: Session, key: str, value: str):
    try:
        setting = db.query(models.Setting).filter(models.Setting.key == key).one()
        setting.value = value
    except NoResultFound:
        setting = models.Setting(key=key, value=value)
        db.add(setting)
    db.commit()
    db.refresh(setting)
    return setting


# =============================================================================
# ğŸŸ¢  API KEY CRUD
# =============================================================================
def _generate_api_key() -> str:
    return uuid.uuid4().hex + uuid.uuid4().hex


def create_api_key(db: Session, user: models.User) -> models.APIKey:
    key = _generate_api_key()
    api_key = models.APIKey(key=key, owner=user)
    db.add(api_key)
    db.commit()
    db.refresh(api_key)
    return api_key


def get_api_key(db: Session, key_str: str) -> Optional[models.APIKey]:
    return db.query(models.APIKey).filter(models.APIKey.key == key_str).first()


def get_api_key_by_user(db: Session, user: models.User) -> Optional[models.APIKey]:
    return (
        db.query(models.APIKey)
        .filter(models.APIKey.user_id == user.id, models.APIKey.is_active.is_(True))
        .first()
    )


def deactivate_api_key(db: Session, api_key: models.APIKey):
    api_key.is_active = False
    db.commit()



# app/database.py

from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

# --- Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…Ø­Ù„ÛŒ SQLite ---
# Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ Ø¨Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ÛŒâ€ŒÚ¯ÙˆÛŒØ¯ Ú©Ù‡ ÛŒÚ© ÙØ§ÛŒÙ„ Ø¨Ù‡ Ù†Ø§Ù… transcriber.db Ø¯Ø± Ø±ÛŒØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†Ø¯.
SQLALCHEMY_DATABASE_URL = "sqlite:///./transcriber.db"

# Ø³Ø§Ø®Øª Ù…ÙˆØªÙˆØ± SQLAlchemy Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
# Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù† connect_args Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ SQLite Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª
engine = create_engine(
    SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False}
)

# Ø³Ø§Ø®Øª ÛŒÚ© Ú©Ù„Ø§Ø³ Session Ø¨Ø±Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¯Ø± Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# Ø³Ø§Ø®Øª ÛŒÚ© Ú©Ù„Ø§Ø³ Ù¾Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù… Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
Base = declarative_base()


# -*- coding: utf-8 -*-
"""
ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ/ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ FastAPI
"""
from fastapi import Request, Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from sqlalchemy.orm import Session
from jose import JWTError, jwt

from . import crud, models, auth, database

# Ø¨Ø±Ø§ÛŒ API-Ù‡Ø§ÛŒ ØµØ±ÙØ§Ù‹ JSON
oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")


# --------------------------------------------------
#  Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (ÛŒÚ© Session Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª)
# --------------------------------------------------
def get_db():
    db = database.SessionLocal()
    try:
        yield db
    finally:
        db.close()


# --------------------------------------------------
#  Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Â«Ú©ÙˆÚ©ÛŒÂ» (Ø¨Ø±Ø§ÛŒ ØµÙØ­Ø§Øª ÙˆØ¨)
# --------------------------------------------------
async def get_current_user_from_cookie(
    request: Request,
    db: Session = Depends(get_db),
):
    """
    Ú©ÙˆÚ©ÛŒ  access_token Ø­Ø§ÙˆÛŒ Ø±Ø´ØªÙ‡â€ŒØ§ÛŒ Ø¨Ø§ ÙØ±Ù…Øª Â«Bearer <jwt>Â» Ø§Ø³Øª.
    Ø¯Ø± ØµÙˆØ±Øª Ø§Ø¹ØªØ¨Ø§Ø±ØŒ Ø±Ú©ÙˆØ±Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ù…ÛŒâ€ŒÚ¯Ø±Ø¯Ø§Ù†Ø¯.
    """
    token_cookie: str | None = request.cookies.get("access_token")

    cred_exc = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Not authenticated",
    )

    if not token_cookie:
        raise cred_exc

    try:
        token_value = token_cookie.split(" ")[1]  # Ø­Ø°Ù Â«Bearer Â»
        payload = jwt.decode(token_value, auth.SECRET_KEY, algorithms=[auth.ALGORITHM])
        username: str | None = payload.get("sub")
        if username is None:
            raise cred_exc
    except (JWTError, IndexError):
        raise cred_exc

    user = crud.get_user_by_username(db, username=username)
    if user is None:
        raise cred_exc
    return user


# --------------------------------------------------
#  Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Â«Ù‡Ø¯Ø± AuthorizationÂ» (Ø¨Ø±Ø§ÛŒ API)
# --------------------------------------------------
async def get_current_user_from_header(
    token: str = Depends(oauth2_scheme),
    db: Session = Depends(get_db),
):
    """
    Ø¨Ø±Ø§ÛŒ Ø±ÙˆØªâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ OAuth2PasswordBearer Ù…Ø­Ø§ÙØ¸Øª Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.
    """
    cred_exc = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Could not validate credentials",
    )

    try:
        payload = jwt.decode(token, auth.SECRET_KEY, algorithms=[auth.ALGORITHM])
        username: str | None = payload.get("sub")
        if username is None:
            raise cred_exc
    except JWTError:
        raise cred_exc

    user = crud.get_user_by_username(db, username=username)
    if user is None:
        raise cred_exc
    return user


# --------------------------------------------------
#  Ø¨Ø§Ø²Ø±Ø³ÛŒ Ù†Ù‚Ø´â€ŒÙ‡Ø§
# --------------------------------------------------
async def get_current_admin(
    current_user: models.User = Depends(get_current_user_from_cookie),
):
    """ÙÙ‚Ø· Ù…Ø¯ÛŒØ±Ø§Ù† (role == admin) Ù…Ø¬Ø§Ø²Ù†Ø¯."""
    if current_user.role != models.Role.admin:
        raise HTTPException(status_code=403, detail="Not enough permissions")
    return current_user


async def get_current_employee_or_admin(
    current_user: models.User = Depends(get_current_user_from_cookie),
):
    """Ù‡Ù… Ø§Ù¾Ø±Ø§ØªÙˆØ±ØŒ Ù‡Ù… Ù…Ø¯ÛŒØ±."""
    if current_user.role not in (models.Role.employee, models.Role.admin):
        raise HTTPException(status_code=403, detail="Not enough permissions")
    return current_user


# --------------------------------------------------
#  â¬‡ï¸â¬‡ï¸â¬‡ï¸  Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ admin.py  â¬‡ï¸â¬‡ï¸â¬‡ï¸
# --------------------------------------------------
async def get_current_active_admin(
    current_user: models.User = Depends(get_current_admin),
):
    """
    Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ù†Ø§Ù… Ù‚Ø¯ÛŒÙ…ÛŒ Â«get_current_active_adminÂ».
    Ù‡Ù…Ø§Ù† Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‚Ø´ Ù…Ø¯ÛŒØ± Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ø¯. Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø§Ø´ØªÙ† ÙÛŒÙ„Ø¯
    is_active Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ†Ø¬Ø§ Ù†ÛŒØ² Ø¢Ù† Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.
    """
    # Ù…Ø«Ø§Ù„Ù Ú†Ú©Ù ÙØ¹Ø§Ù„â€ŒØ¨ÙˆØ¯Ù† Ø­Ø³Ø§Ø¨:
    # if hasattr(current_user, "is_active") and not current_user.is_active:
    #     raise HTTPException(status_code=403, detail="Account disabled")
    return current_user


# app/main.py
import os
from pathlib import Path
from dotenv import load_dotenv

from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles

from .database import engine
from . import models
from .routers import (
    auth   as auth_router,
    jobs   as jobs_router,
    user   as user_router,
    admin  as admin_router,
)
from .templating import templates

# Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ÛŒØ·ÛŒ
load_dotenv()

# ØªÙ†Ø¸ÛŒÙ… Ù…Ø³ÛŒØ±Ù‡Ø§
BASE_DIR    = Path(__file__).resolve().parent.parent
STATIC_DIR  = BASE_DIR / "static"
UPLOADS_DIR = BASE_DIR / "uploads"
for d in (STATIC_DIR, UPLOADS_DIR):
    d.mkdir(parents=True, exist_ok=True)

# Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯Ø§ÙˆÙ„ Ù¾Ø§ÛŒÚ¯Ø§Ù‡â€ŒØ¯Ø§Ø¯Ù‡ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
models.Base.metadata.create_all(bind=engine)

# ØªØ¹Ø±ÛŒÙ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ù…Ø³ØªÙ†Ø¯Ø§Øª OpenAPI
api_tags_metadata = [
    {
        "name": "ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª",
        "description": "ÙˆØ±ÙˆØ¯ØŒ Ø®Ø±ÙˆØ¬ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†.",
    },
    {
        "name": "ğŸ“¥ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§",
        "description": "Ø¢Ù¾Ù„ÙˆØ¯ØŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ ÛŒØ§ Ù…ØªÙ†ÛŒ.",
    },
    {
        "name": "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†",
        "description": "Ù…Ø´Ø§Ù‡Ø¯Ù‡ØŒ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ØªÙˆØ³Ø· Ø§Ø¯Ù…ÛŒÙ†.",
    },
    {
        "name": "ğŸ’° Ú©ÛŒÙ Ù¾ÙˆÙ„",
        "description": "Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†.",
    },
    {
        "name": "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ØªÙˆØ§",
        "description": "Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ø§Øª Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ØŒ Ù‚ÙˆØ§Ù†ÛŒÙ†ØŒ Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§ Ùˆ ØªØ¹Ø±ÙÙ‡â€ŒÙ‡Ø§.",
    },
]

# Ø§ÛŒØ¬Ø§Ø¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ØµÙ„ÛŒ FastAPI Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø³ØªÙ†Ø¯Ø§Øª
app = FastAPI(
    title="Ø¯Ø³ØªÛŒØ§Ø± ØµÙˆØª Ùˆ Ù…ØªÙ†",
    description="Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­ ØµÙˆØª/Ù…ØªÙ† Ø¨Ø§ FastAPI",
    version="5.2.1",
    docs_url="/swagger",           # â† Ø§ÛŒÙ† Ø®Ø· Ù…Ø³ÛŒØ± Swagger Ø±Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    redoc_url=None                 # â† ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ReDoc (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)
)


# Ø§ØªØµØ§Ù„ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§ØªÛŒÚ© Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¢Ù¾Ù„ÙˆØ¯
app.mount("/static",  StaticFiles(directory=str(STATIC_DIR)),  name="static")
app.mount("/uploads", StaticFiles(directory=str(UPLOADS_DIR)), name="uploads")


# ------------------- Ø±ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ (ØµÙØ­Ø§Øª Ø§ØµÙ„ÛŒ Ø³Ø§ÛŒØª) -------------------

@app.get("/", response_class=HTMLResponse, tags=["ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª"])
async def read_root(request: Request):
    """ØµÙØ­Ù‡Ù” ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…."""
    return templates.TemplateResponse("login.html", {"request": request, "user": None})


@app.get("/terms", response_class=HTMLResponse, tags=["âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ØªÙˆØ§"])
def terms_page(request: Request):
    return templates.TemplateResponse("terms.html", {"request": request})

@app.get("/about", response_class=HTMLResponse, tags=["âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ØªÙˆØ§"])
def about_page(request: Request):
    return templates.TemplateResponse("about.html", {"request": request})

@app.get("/faq", response_class=HTMLResponse, tags=["âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ØªÙˆØ§"])
def faq_page(request: Request):
    return templates.TemplateResponse("faq.html", {"request": request})

@app.get("/pricing", response_class=HTMLResponse, tags=["âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ØªÙˆØ§"])
def pricing_page(request: Request):
    return templates.TemplateResponse("pricing.html", {"request": request})


@app.get("/change-password", response_class=HTMLResponse, tags=["ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª"])
async def change_password_page(request: Request):
    """ØµÙØ­Ù‡Ù” ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù…Ø› Ù…Ù†Ø·Ù‚ Ø¯Ø± routers/user.py)"""
    return templates.TemplateResponse("change_password.html", {"request": request})

@app.get("/api-docs", response_class=HTMLResponse)
def api_docs_page(request: Request):
    return templates.TemplateResponse("api_docs.html", {"request": request})


# ------------------- Ø§ØªØµØ§Ù„ Ø±ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ (Ù…Ø§Ú˜ÙˆÙ„Ø§Ø±) -------------------
app.include_router(auth_router.router,  tags=["ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª"])
app.include_router(jobs_router.router,  tags=["ğŸ“¥ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§"])
app.include_router(user_router.router,  tags=["ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†"])
app.include_router(admin_router.router, tags=["ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†", "ğŸ’° Ú©ÛŒÙ Ù¾ÙˆÙ„", "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ØªÙˆØ§"])


